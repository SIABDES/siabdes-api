// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth", "bumdes", "journals", "taxes"]
}

// Auth Schema
model AuthUser {
  id String @id @default(cuid())

  identifier String       @unique
  password   String
  role       AuthUserRole

  bumdes     Bumdes?     @relation(fields: [bumdesId], references: [id])
  bumdesUnit BumdesUnit?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  bumdesId  String?

  @@map("users")
  @@schema("auth")
}

enum AuthUserRole {
  UNIT
  BUMDES
  KECAMATAN
  KABUPATEN

  @@map("users_role")
  @@schema("auth")
}

// Bumdes Schema
model Bumdes {
  id String @id @default(cuid())

  name  String
  phone String

  // Address
  completeAddress String?
  province        String // Provinsi
  regency         String // Kabupaten
  district        String // Kecamatan
  village         String // Desa
  postalCode      String // Kode Pos

  // Law and Rules  
  villageRuleNumber     String? // no peraturan desa
  skAdministratorNumber String? // no SK pengurus desa
  skAdministratorDate   DateTime? // tanggal SK pengurus desa
  skAssistantNumber     String? // no SK AD/ART desa
  skAssistantDate       DateTime? // tanggal SK AD/ART desa

  // Bank or Financial Institution
  bankName    String? // Nama bank
  bankAccount String? // No rekening

  // NPWP or Taxes
  npwpNumber String? // No NPWP

  // Socials
  website      String? // Link Website
  facebook     String? // Link Facebook
  twitter      String? // Link Twitter
  instagram    String? // Link Instagram
  otherSocials String? // Link Social Media Lainnya

  // Initial finance capital data (pemodalan awal)
  initialCapitalParticipation    Decimal? // Penyertaan modal awal
  additionalCapitalParticipation Decimal? // Penambahan Penyertaan Modal

  // Organizations
  leader     String
  consultant String?
  secretary  String?
  treasurer  String? // Bendahara

  supervisor_leader    String?
  supervisor_secretary String?
  supervisor_treasurer String?

  users            AuthUser[]
  units            BumdesUnit[]
  fundingHistories BumdesFundingHistoryItem[]
  incomeHistories  BumdesIncomeHistoryItem[]

  foundedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([province, regency, district, village, postalCode], name: "bumdes_address")
  @@map("bumdes")
  @@schema("bumdes")
}

model BumdesFundingHistoryItem {
  id String @id @default(cuid())

  year                   Int
  rulesNumber            String
  villageAmount          Decimal
  villagePercentage      Decimal
  otherPartiesAmount     Decimal
  otherPartiesPercentage Decimal

  bumdes   Bumdes @relation(fields: [bumdesId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  bumdesId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bumdes_funding_history_item")
  @@schema("bumdes")
}

model BumdesIncomeHistoryItem {
  id String @id @default(cuid())

  year     Int
  omzet    Decimal
  profit   Decimal
  dividend Decimal

  bumdes   Bumdes @relation(fields: [bumdesId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  bumdesId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bumdes_income_history_item")
  @@schema("bumdes")
}

model BumdesUnit {
  id String @id @default(cuid())

  name         String
  businessType BumdesUnitBusinessType
  description  String?

  // Organizations
  leader  String
  members String[]

  phoneNumber String
  address     String

  bumdes   Bumdes? @relation(fields: [bumdesId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  bumdesId String?

  user   AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String   @unique

  thirdPartyPartners String[] // Kerja sama pihak ketiga

  journals          Journal[]
  customJournals    CustomJournal[]
  ppnTaxes          PPnTaxes[]
  capitalsHistory   BumdesUnitCapitalHistory[] // Riwayat Permodalan
  incomesHistory    BumdesUnitIncomeHistory[] // Riwayat Aset dan Omzet
  netProfitsHistory BumdesUnitNetProfitHistory[] // Riwayat Keuntungan Bersih dan Dividen

  foundedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([businessType, bumdesId], name: "bumdes_unit_business_type")
  @@map("bumdes_unit")
  @@schema("bumdes")
}

model BumdesUnitCapitalHistory {
  id String @id @default(cuid())

  amount     Decimal
  source     String
  percentage Decimal

  unit   BumdesUnit @relation(fields: [unitId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  unitId String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("bumdes_unit_capital_history")
  @@schema("bumdes")
}

model BumdesUnitIncomeHistory {
  id String @id @default(cuid())

  year    Int
  asset   Decimal
  revenue Decimal

  unit   BumdesUnit @relation(fields: [unitId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  unitId String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("bumdes_unit_income_history")
  @@schema("bumdes")
}

model BumdesUnitNetProfitHistory {
  id String @id @default(cuid())

  year      Int
  netProfit Decimal
  dividend  Decimal

  unit   BumdesUnit @relation(fields: [unitId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  unitId String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("bumdes_unit_net_profit_history")
  @@schema("bumdes")
}

enum BumdesUnitBusinessType {
  SERVICES // JASA
  COMMERCE // DAGANG
  INDUSTRY // INDUSTRI

  @@schema("bumdes")
}

// Journals Schema
model AccountGroup {
  id   Int    @id @default(autoincrement())
  ref  String @unique // misal kelompok Aset: ref = 1
  name String
  slug String @unique

  accounts       Account[]
  customAccounts CustomAccount[]
  subgroups      AccountSubgroup[]

  @@map("account_groups")
  @@schema("journals")
}

model AccountSubgroup {
  id       Int          @id @default(autoincrement())
  ref      String       @unique // Misal: ref = 1-1, format: <account group ref>-<account subgroup ref>. src: COA
  name     String
  slug     String       @unique
  group    AccountGroup @relation(fields: [groupRef], references: [ref], onDelete: Cascade, onUpdate: Cascade)
  groupRef String

  accounts       Account[]
  customAccounts CustomAccount[]

  @@map("account_subgroups")
  @@schema("journals")
}

model Account {
  id       Int     @id @default(autoincrement())
  ref      String // misal di kelompok Aset, akun Kas: ref = 1-1001. format: <account group ref>-<account ref>. src: COA
  name     String
  slug     String  @unique
  isCredit Boolean // Saldo Umum => Kredit jika true, Debit jika false

  group    AccountGroup @relation(fields: [groupRef], references: [ref], onDelete: Cascade, onUpdate: Cascade)
  groupRef String

  subgroup    AccountSubgroup @relation(fields: [subgroupRef], references: [ref], onDelete: Cascade, onUpdate: Cascade)
  subgroupRef String

  journalItems JournalItem[]

  businessTypes BumdesUnitBusinessType[]

  @@map("accounts")
  @@schema("journals")
}

model CustomAccount {
  id       String  @id @default(cuid())
  ref      String
  name     String
  slug     String  @unique
  isCredit Boolean // Saldo Umum => Kredit jika true, Debit jika false

  group    AccountGroup @relation(fields: [groupRef], references: [ref], onDelete: Cascade, onUpdate: Cascade)
  groupRef String

  subgroup    AccountSubgroup @relation(fields: [subgroupRef], references: [ref], onDelete: Cascade, onUpdate: Cascade)
  subgroupRef String

  journalItems CustomJournalItem[]

  businessTypes BumdesUnitBusinessType[]

  @@map("custom_accounts")
  @@schema("journals")
}

model Journal {
  id String @id @default(cuid())

  description String
  occurredAt  DateTime
  category    JournalCategory
  evidence    String?

  bumdesUnit   BumdesUnit @relation(fields: [bumdesUnitId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  bumdesUnitId String

  items JournalItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("journals")
  @@schema("journals")
}

model JournalItem {
  id String @id @default(cuid())

  amount   Decimal
  isCredit Boolean

  account   Account @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId Int

  journal   Journal @relation(fields: [journalId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  journalId String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("journal_items")
  @@schema("journals")
}

model CustomJournal {
  id String @id @default(cuid())

  description String
  occurredAt  DateTime
  category    JournalCategory
  evidence    String?

  bumdesUnit   BumdesUnit @relation(fields: [bumdesUnitId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  bumdesUnitId String

  items CustomJournalItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("custom_journals")
  @@schema("journals")
}

model CustomJournalItem {
  id String @id @default(cuid())

  amount   Decimal
  isCredit Boolean

  account   CustomAccount @relation(fields: [accountId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  accountId String

  journal   CustomJournal @relation(fields: [journalId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  journalId String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("custom_journal_items")
  @@schema("journals")
}

enum JournalCategory {
  GENERAL
  ADJUSTMENT

  @@map("journal_categories")
  @@schema("journals")
}

// taxes schema
model PPnTaxes {
  id String @id @default(cuid())

  proofNumber String @unique

  targetCompany String
  items         String[]
  isItemService Boolean
  dpp           Decimal
  ppn           Decimal

  unit   BumdesUnit @relation(fields: [unitId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  unitId String

  occuredAt DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("ppn_taxes")
  @@schema("taxes")
}
